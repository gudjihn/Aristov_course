# Языки программирования и пользовательские типы данных

Создаем таблицу и наполняем данными
```sql

create schema sales;
CREATE SCHEMA

CREATE TABLE sales.sales
(
    id       integer generated by default as identity,
    sold_at  timestamp
);

INSERT INTO sales.sales (sold_at)
SELECT '2025-01-01'::timestamp + (random() * (365*24*60*60))::int * interval '1 second'
FROM generate_series(1, 50);
```
Создаем функцию 
```
CREATE OR REPLACE FUNCTION sales.sales_by_third_of_the_year_get(p_thirdOfYear integer)
    RETURNS TABLE
            (
                id      integer,
                sold_at timestamp,
                month   int
            )
    LANGUAGE plpgsql
    SECURITY DEFINER
AS
$$
BEGIN
    IF p_thirdOfYear NOT IN (1, 2, 3) OR p_thirdOfYear IS NULL THEN
        RAISE EXCEPTION 'incorrect value input, coorect are: 1, 2, 3';
    END IF;

    RETURN QUERY
        SELECT i.id, i.sold_at, i.month::integer
        FROM (SELECT s.id, s.sold_at, EXTRACT(MONTH FROM s.sold_at)::integer AS month
              FROM sales.sales AS s) AS i
        WHERE i.month = ANY (CASE
                                 WHEN p_thirdOfYear = 1 THEN ARRAY [1,2,3,4]
                                 WHEN p_thirdOfYear = 2 THEN ARRAY [5,6,7,8]
                                 WHEN p_thirdOfYear = 3 THEN ARRAY [9,10,11,12]
            END);
END;
$$;

```

Вызываем функцию
```sql
SELECT id, sold_at, month FROM sales.sales_by_third_of_the_year_get(1);
 id |       sold_at       | month
----+---------------------+-------
  4 | 2025-03-18 03:32:46 |     3
 10 | 2025-01-09 05:09:26 |     1
 13 | 2025-03-24 23:04:46 |     3
 16 | 2025-03-04 02:18:10 |     3
 20 | 2025-02-22 02:07:02 |     2
 25 | 2025-02-21 02:02:23 |     2
 42 | 2025-03-30 21:01:11 |     3
 48 | 2025-03-21 07:48:58 |     3
 50 | 2025-01-28 06:29:24 |     1
```

Проверяем обработку входного параметра NULL
```sql
SELECT id, sold_at, month FROM sales.sales_by_third_of_the_year_get(null);
ERROR:  incorrect value input, coorect are: 1, 2, 3
CONTEXT:  PL/pgSQL function sales.sales_by_third_of_the_year_get(integer) line 4 at RAISE
```
Получаем исключение
```sql
ERROR:  incorrect value input, coorect are: 1, 2, 3
CONTEXT:  PL/pgSQL function sales.sales_by_third_of_the_year_get(integer) line 4 at RAISE
```

Создаем функцию для вычисления месяца по формуле
```sql
CREATE OR REPLACE FUNCTION sales.sales_by_third_of_the_year_get2(p_thirdOfYear integer)
    RETURNS TABLE
            (
                id      integer,
                sold_at timestamp,
                month   int
            )
    LANGUAGE plpgsql
    SECURITY DEFINER
AS
$$
BEGIN
    IF p_thirdOfYear NOT IN (1, 2, 3) OR p_thirdOfYear IS NULL THEN
        RAISE EXCEPTION 'Допустимые значения параметра p_thirdOfYear: 1, 2, 3';
    END IF;

    RETURN QUERY
        SELECT i.id, i.sold_at, i.month::integer
        FROM (SELECT s.id, s.sold_at, EXTRACT(MONTH FROM s.sold_at)::integer AS month
              FROM sales.sales AS s) AS i
        WHERE i.month = ANY (ARRAY(SELECT generate_series(1 + (4 * (p_thirdOfYear - 1)), 4 * p_thirdOfYear)));
END;
$$;
CREATE FUNCTION
```

Вызываем функцию
```sql
SELECT id, sold_at, month
FROM sales.sales_by_third_of_the_year_get2(1);
```
```result
SELECT id, sold_at, month
FROM sales.sales_by_third_of_the_year_get2(3);
 id |       sold_at       | month
----+---------------------+-------
  6 | 2025-10-19 00:01:59 |    10
  8 | 2025-09-19 01:22:52 |     9
  9 | 2025-09-16 00:53:00 |     9
 11 | 2025-09-09 13:02:09 |     9
 14 | 2025-11-17 23:36:40 |    11
 17 | 2025-12-01 19:35:33 |    12
 18 | 2025-10-27 22:59:12 |    10
 24 | 2025-12-21 17:44:16 |    12
 26 | 2025-10-06 07:00:34 |    10
 30 | 2025-12-31 16:45:36 |    12
 31 | 2025-11-20 17:58:42 |    11
 32 | 2025-12-14 21:58:32 |    12
 34 | 2025-12-16 20:52:37 |    12
 35 | 2025-09-05 15:39:55 |     9
 39 | 2025-09-17 18:47:42 |     9
 41 | 2025-11-15 16:54:29 |    11
 43 | 2025-12-23 12:49:05 |    12
 45 | 2025-10-17 15:15:44 |    10
 47 | 2025-11-23 02:27:17 |    11
(19 rows)

```
